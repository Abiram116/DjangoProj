{% extends 'base.html' %}

{% block title %}Recipe Calendar{% endblock %}

{% block extra_head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js'></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- Sidebar for My Recipes -->
    <div class="sidebar">
        <h3>My Recipes</h3>
        <div id="external-events">
            {% if my_recipes %}
                {% for recipe in my_recipes %}
                    <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event' data-recipe-id='{{ recipe.id }}'>
                        <div class='fc-event-main'>{{ recipe.name }}</div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-recipes-message">
                    <p>There are no recipes. Go to the home page and click on the plus symbol to add recipes to My Recipes.</p>
                    <a href="{% url 'inspire' %}" class="add-recipe-btn">Add Recipes</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="main-calendar">
        <div id="calendar"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var Draggable = FullCalendar.Draggable;

        new Draggable(document.getElementById('external-events'), {
            itemSelector: '.fc-event',
            eventData: function(eventEl) {
                return {
                    title: eventEl.innerText,
                    recipeId: eventEl.getAttribute('data-recipe-id')
                };
            }
        });

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: ''
            },
            editable: true,
            droppable: true,
            events: '{% url "get_recipe_schedule" %}',
            displayEventTime: false,
            eventReceive: function(info) {
                saveEvent(info.event);
            },
            eventDrop: function(info) {
                saveEvent(info.event);
            },
            eventContent: function(arg) {
                return {
                    html: `
                        <div class="fc-event-main">
                            ${arg.event.title}
                            <span class="remove-event">Ã—</span>
                        </div>
                    `
                };
            },
            eventClick: function(info) {
                if ($(info.el).find('.remove-event').is(event.target)) {
                    removeEvent(info.event);
                }
            }
        });

        calendar.render();

        function saveEvent(event) {
            var localStartDate = event.startStr.split('T')[0];
            
            $.ajax({
                url: '{% url "save_recipe_schedule" %}',
                type: 'POST',
                data: JSON.stringify({
                    recipeId: event.extendedProps.recipeId,
                    startTime: localStartDate, 
                    eventId: event.id
                }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function(response) {
                    if (response.id) {
                        event.remove(); 
                        calendar.addEvent({
                            id: response.id,
                            title: event.title,
                            start: response.startTime,
                            allDay: true,
                            extendedProps: {
                                recipeId: event.extendedProps.recipeId
                            }
                        });
                    }
                },
                error: function(error) {
                    console.log('Error saving event:', error);
                    calendar.refetchEvents();
                }
            });
        }

        function removeEvent(event) {
            $.ajax({
                url: '{% url "remove_recipe_schedule" %}',
                type: 'POST',
                data: JSON.stringify({
                    eventId: event.id
                }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        event.remove();
                    }
                },
                error: function(error) {
                    console.log('Error removing event:', error);
                }
            });
        }
    });
</script>

<style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f5f7fa;
        margin: 0;
        padding: 0;
    }

    .calendar-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1400px;
        margin: 20px auto;
        background-color: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .sidebar {
        width: 250px;
        padding: 20px;
        background: linear-gradient(145deg, #e6e9ef, #ffffff);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .sidebar h3 {
        color: #3a4f66;
        margin-bottom: 20px;
        font-weight: 600;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 2px solid #4a90e2;
    }

    .main-calendar {
        flex: 1;
        min-width: 0;
    }

    #external-events .fc-event {
        margin: 8px 0;
        padding: 10px;
        background: #4a90e2;
        color: #fff;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-weight: 300;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #external-events .fc-event:hover {
        background: #3a7bd5;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .remove-event {
        float: right;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s;
        margin-right: 5px;
    }

    .remove-event:hover {
        opacity: 1;
        color: #ff6b6b;
    }

    .fc .fc-button-primary {
        background-color: #4a90e2;
        border-color: #4a90e2;
        transition: all 0.3s ease;
    }

    .fc .fc-button-primary:hover {
        background-color: #3a7bd5;
        border-color: #3a7bd5;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .fc .fc-daygrid-day.fc-day-today {
        background-color: #e6f2ff;
    }

    .fc-event-main {
        padding: 4px 6px;
        transition: all 0.3s ease;
    }

    .fc-event-main:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .no-recipes-message {
        text-align: center;
        color: #3a4f66;
        font-size: 0.9em;
        line-height: 1.4;
    }

    .add-recipe-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #4a90e2;
        color: #ffffff;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.3s ease;
    }

    .add-recipe-btn:hover {
        background-color: #3a7bd5;
    }

    @media (max-width: 768px) {
        .calendar-container {
            flex-direction: column;
            padding: 15px;
            margin: 10px;
        }

        .sidebar {
            width: 100%;
            margin-bottom: 20px;
            padding: 15px;
        }

        .main-calendar {
            width: 100%;
        }

        .fc .fc-toolbar {
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .fc .fc-toolbar-title {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .fc .fc-button {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        #external-events .fc-event {
            margin: 6px 0;
            padding: 8px;
        }
    }
</style>
{% endblock %}